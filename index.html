<!DOCTYPE html>
<html lang="en" class="demo-3">
<head>
    <title>VRLabs</title>
    <meta charset="utf-8">
    <meta name="viewport" content="user-scalable=no, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="styles/styles.css">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans">
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
</head>
<body class="darkBack">
<iframe id="youtubeVideo" width="0" height="0" style="position: absolute; display: none;" src=""></iframe>
<canvas id="fireWorks" class="fireworks"></canvas>
<div id="logoBox" class="mainSection">
    <section>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 528.07 70.33">
            <g id="beevaLogo">
                <path id="letter-O" fill="#999999"
                      d="M1700.33,474.27a34.07,34.07,0,0,0-38.21,33l9.7,0.24a24.39,24.39,0,0,1,30.07-23.1c8.47,1.94,16.74,10.64,18.26,19.2a24.39,24.39,0,0,1-24.58,28.87l-0.24,9.7A34.06,34.06,0,0,0,1700.33,474.27Z"/>
                <rect id="O-dot-1" fill="#ffffff" x="29.52" y="30.73"/>
                <rect id="O-dot-2" fill="#ffffff" x="20.31" y="39.9" width="9.21" height="9.21"/>
                <rect id="O-dot-3" fill="#ffffff" x="11.11" y="49.11" width="9.21" height="9.21"/>
                <path id="letter-P" fill="#ffffff"
                      d="M1777.44,474.17c-10.31,0-20.92.1-31.23,0.1v67.47H1757V484.09h20.43c17.74,0,17.83,27,0,27h-7V521h7C1809.73,520.82,1809.64,474.17,1777.44,474.17Z"/>
                <path id="letter-E1" fill="#ffffff" d="M1818.79,531.13v10.6h49.83v-10.6h-49.83Z"/>
                <path id="letter-E2" fill="#ffffff" d="M1866.79,513V503h-37.21V484.77h38.75V474.26h-49.54V513h48Z"/>
                <polygon id="letter-N" fill="#ffffff"
                         points="270.23 49.34 270.23 49.43 269.53 48.56 231.96 1.43 223.67 1.43 223.67 68.91 234.56 68.91 234.56 21.28 256.48 48.56 256.48 48.56 272.76 68.82 272.76 52.49 270.23 49.34"/>
                <path id="letter-L" fill="#999999" d="M1947.19,474.26v57.45h34.05v10h-46.36V474.26h12.31Z"/>
                <polygon id="letter-A" fill="#999999"
                         points="369.45 1.43 357.69 1.43 363.57 12.8 377.84 44.9 355.55 44.9 355.79 44.9 355.55 44.9 349.31 44.9 349.31 44.9 338.19 44.9 327.43 68.91 338.9 68.91 345.26 54.73 381.79 54.73 388.25 68.9 399.72 68.9 369.45 1.43"/>
                <path id="letter-B" fill="#999999"
                      d="M2113.32,506.94c6.36-2.6,9.35-7.71,9.35-13.4,0-13.4-10.12-19.28-22.94-19.28h-4V484h4c8.1,0,12.24,5,12.24,9.74,0,5.3-4,8.48-12.14,8.48h-4.1v9.64h4.1c6.17,0,14.17,3.28,14.17,10.51,0,7.42-8.29,9.35-14.27,9.35h-4v10h4c13.3,0,25.06-4.53,25.06-19.28C2124.79,517.35,2121.42,509.35,2113.32,506.94Z"/>
                <path id="letter-S" stroke="#999999" fill="#999999"
                      d="M2163.1,501.43c-8.87-1.25-16.39-3.08-16.39-9.64,0-4.54,3.24-7.74,8.3-9.25v-9.71c-9.93,1.76-19.08,7.45-19,18.77,0,14.46,12.72,17.83,26.12,19.66,9.45,1.25,17.25,3.76,17.25,11.08,0,8.48-9,11.18-17.06,11.18-7.81,0-16.19-2.89-21-11.08l-8.1,5.4c6.17,11.37,16.1,15.32,29,15.32,14.07,0,27.86-5.69,28-20.82S2177,503.36,2163.1,501.43Z"/>
                <path id="letter-B-beeva" fill="#ffffff"
                      d="M2069.62,537.82c0-1.63.81-3,2.52-3a2,2,0,0,1,1.85,1.34,2.25,2.25,0,0,1,2.15-1.62c1.92,0,2.48,1.61,2.48,3.31v3.94h-9v-3.94Zm3.87,2.82v-2.87c0-1.08-.4-1.87-1.34-1.87s-1.52.81-1.52,1.92v2.82h2.86Zm4.08,0v-2.82c0-.94-0.24-2.19-1.47-2.19s-1.6,1.16-1.6,2.14v2.87h3.06Z"/>
                <path id="letter-Y-beeva" fill="#ffffff"
                      d="M2069.66,533.4h0V532l4.27-2.7-4.27-2.77V525.2h0l5.32,3.55h3.66v1.16H2075Z"/>
                <path id="letter-B2-beeva" fill="#ffffff"
                      d="M2069.62,515.71c0-1.63.81-3,2.52-3A2,2,0,0,1,2074,514a2.25,2.25,0,0,1,2.15-1.62c1.92,0,2.48,1.61,2.48,3.31v3.94h-9v-3.94Zm3.87,2.82v-2.87c0-1.08-.4-1.87-1.34-1.87s-1.52.81-1.52,1.92v2.82h2.86Zm4.08,0v-2.82c0-.94-0.24-2.19-1.47-2.19s-1.6,1.16-1.6,2.14v2.87h3.06Z"/>
                <path id="letter-E-beeva" fill="#ffffff"
                      d="M2069.62,509.9v-6.33h1v5.23h2.82v-5h1v5h3.05v-5.43h1.07v6.54h-9Z"/>
                <path id="letter-E2-beeva" fill="#ffffff"
                      d="M2069.62,500.88v-6.33h1v5.23h2.82v-5h1v5h3.05v-5.43h1.07v6.54h-9Z"/>
                <path id="letter-V-beeva" fill="#ffffff"
                      d="M2069.62,491.55l7.7-3.08-7.7-3.1v-1.24l9,3.72v1.21l-9,3.73v-1.25Z"/>
                <path id="letter-A-beeva" fill="#ffffff"
                      d="M2069.62,478.31l9-4v1.21l-2,.89v5.15l2,0.88v1.22l-9-4v-1.26Zm1.13,0.63,4.87,2.14V476.8Z"/>
            </g>
        </svg>
    </section>
</div>
<div id="container" class="displayOff">
</div>
<script type="text/javascript" src="libs/jquery-2.1.0.min.js"></script>
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.19.0/TweenMax.min.js"></script>-->
<script type="text/javascript" src="libs/greensock/src/uncompressed/TweenMax.js"></script>

<!-- WebVR polyfill and manager -->
<script src="https://skezo.github.io/Reticulum/examples/js/lib/webvr-polyfill.js"></script>
<script src="https://skezo.github.io/Reticulum/examples/js/lib/webvr-manager.js"></script>


<script type="text/javascript" src="libs/three78.js"></script>
<script type="text/javascript" src="libs/progressbar.js"></script>
<script type="text/javascript" src="libs/DDSLoader.js"></script>
<script type="text/javascript" src="libs/MTLLoader.js"></script>
<script type="text/javascript" src="libs/OBJLoader.js"></script>
<script type="text/javascript" src="libs/ExplodeModifier.js"></script>
<script type="text/javascript" src="libs/SPE.min.js"></script>
<script type="text/javascript" src="libs/videoTexture.js"></script>
<script type="text/javascript" src="libs/DeviceOrientation.js"></script>
<script type="text/javascript" src="libs/StereoEffect.js"></script>
<script type="text/javascript" src="libs/tween.js"></script>
<script type="text/javascript" src="libs/OrbitControls.js"></script>
<script type="text/javascript" src="libs/SubdivisionModifier.js"></script>
<script type="text/javascript" src="scene/logoAnim.js"></script>
<!-- A simple gaze interaction manager for VR -->
<!--<script src="https://skezo.github.io/Reticulum/reticulum.js"></script>-->
<script src="./libs/reticulum.js"></script>
<script type="x-shader/x-vertex" id="vertexshader">
      uniform float amplitude;
      attribute vec3 customColor;
      attribute vec3 displacement;
      varying vec3 vNormal;
      varying vec3 vColor;
      void main() {
        vNormal = normal;
        vColor = customColor;
        vec3 newPosition = position + normal * amplitude * displacement;
        gl_Position = projectionMatrix * modelViewMatrix * vec4( newPosition, 1.0 );
      }

</script>

<script type="x-shader/x-fragment" id="fragmentshader">
      varying vec3 vNormal;
      varying vec3 vColor;
      void main() {
        const float ambient = 0.4;
        vec3 light = vec3( 1.0 );
        light = normalize( light );
        float directional = max( dot( vNormal, light ), 0.0 );
        gl_FragColor = vec4( ( directional + ambient ) * vColor, 1.0 );
      }

</script>

<script>
  var camera, scene, renderer, controls, controlsdevice, uniforms,
    numVertices, effect, intersected, intersectedScreens, intersectedTravel, intersectedInfo, intersectedMembers,
    intersectedExit, sky, plane, particleCube, radicalText,
    radicalTextNParticles, researchText, researchTextNParticles, interval, radicallight, researchlight, designlight,
    screen1Light, screen2Light, actualLab, exitIcon, arrowIconGeometry,
    width = window.innerWidth,
    height = window.innerHeight;

  var isMobile = false;

  var videoMP4, videoOgg, video, videoTexture, video2, videoTexture2, screen1Mesh, screen2Mesh;

  var centro, design, research, clever, maker, sillas, comunicacion, pared, cristaleraFrontal, cristaleraEntrada,
      cristaleraAgora, banco, teles, pantalla1;

  var tweenLettersIn;

  var clock = new THREE.Clock();

  var manager = new THREE.LoadingManager();

  var radicalMembers = [
    // {name: 'alvaro_recortada', position: {x: -2.9, y: 0.8, z: -1.2}},
    {name: 'alvaro_recortada', position: {x: -5.8, y: 1.6, z: -2.4}},
    // {name: 'sergio_recortada', position: {x: -3.2, y: 0.8, z: -2.1}},
    {name: 'sergio_recortada', position: {x: -6.4, y: 1.6, z: -4.2}},
    // {name: 'adrian_recortada', position: {x: -2.9, y: 0.8, z: -2.7}},
    {name: 'adrian_recortada', position: {x: -5.8, y: 1.6, z: -5.4}},
    // {name: 'ira_recortada', position: {x: -2, y: 0.8, z: -2.8}},
    {name: 'ira_recortada', position: {x: -4, y: 1.6, z: -5.6}},
    // {name: 'salva_recortada', position: {x: -2, y: 0.8, z: -1.1}},
    {name: 'salva_recortada', position: {x: -4, y: 1.6, z: -2.2}},
    // {name: 'jota_recortada', position: {x: -1.8, y: 0.8, z: -1.9}}
    {name: 'jota_recortada', position: {x: -3.6, y: 1.6, z: -3.8}}
  ];
  var researchMembers = [
    // {name: 'mario_recortada', position: {x: -3, y: 0.8, z: 1.1}},
    {name: 'mario_recortada', position: {x: -6, y: 1.6, z: 2.2}},
    // {name: 'fernando_recortada', position: {x: -3, y: 0.8, z: 0.25}},
    {name: 'fernando_recortada', position: {x: -6, y: 1.6, z: 0.5}},
    // {name: 'ricardo_recortada', position: {x: -2.3, y: 0.8, z: 0.1}},
    {name: 'ricardo_recortada', position: {x: -4.6, y: 1.6, z: 0.2}},
    // {name: 'enrique_recortada', position: {x: -1.8, y: 0.8, z: -0.1}},
    {name: 'enrique_recortada', position: {x: -3.6, y: 1.6, z: -0.2}},
    // {name: 'samuel_recortada', position: {x: -1.7, y: 0.8, z: 1.2}}
    {name: 'samuel_recortada', position: {x: -3.4, y: 1.6, z: 2.4}}
  ];

  var checkstatus = {
    mesas: true,
    infoCard: true,
    members: true,
    travel: true,
    screens: false
  };

  var radicalInfoImages = ['radicalInfo1', 'radicalInfo2', 'radicalInfo3'];
  var sergioInfoImages = ['sergioInfo1', 'sergioInfo2', 'sergioInfo3'];

  var sectionInfoAdded = false;

  var planta = new THREE.Object3D();
  planta.name = "estructura";
  var mesas = new THREE.Object3D();
  mesas.name = "mesasInteractivas";
  var screensGroup = new THREE.Object3D();
  screensGroup.name = "screens";
  var letrasRadical = new THREE.Object3D();
  letrasRadical.name = 'lerasRadical';
  var letrasResearch = new THREE.Object3D();
  letrasResearch.name = 'letrasResearch';
  var letrasDesign = new THREE.Object3D();
  letrasDesign.name = 'letrasDesign';
  var letrasClever = new THREE.Object3D();
  letrasClever.name = 'letrasClever';
  var letrasComunicacion = new THREE.Object3D();
  letrasComunicacion.name = 'letrasComunicacion';
  var letrasMaker = new THREE.Object3D();
  letrasMaker.name = 'letrasMaker';
  var travelPoints = new THREE.Object3D();
  travelPoints.name = 'travelPoints';
  var spriteGroup = new THREE.Object3D();
  spriteGroup.name = 'spriteGroup';
  var membersGroup = new THREE.Object3D();
  membersGroup.name = 'members';
  var infoGroup = new THREE.Object3D();
  infoGroup.name = 'infoGroup';
  var exitGroup = new THREE.Object3D();
  exitGroup.name = 'exitGroup';

  var activeLetters;

  var numeroParticulas = 2000;
  var disperseParticles = {nParticles: numeroParticulas, path: 'disperse'};
  var min = -3, max = 3;
  var verticesArray = [];
  var particlesAnimation = true;


  $(document).ready(function () {
      // startLogoAnim();
      $('#container').addClass('displayOn');
      $('#logoBox').css('display', 'none');
      $('#fireWorks').css('display', 'none');
      initRender();
      animate();
  });

//  $(document).on("keydown", function (e) {
//      if (e.keyCode == '38') {
//          if (particleCube != undefined) particlesDisperse(radicalTextNParticles, 'radical');
//          TweenMax.to(camera, 0.5, {
//              fov: "-=5", onUpdate: function () {
//                  camera.updateProjectionMatrix();
//              }
//          });
//      }
//      else if (e.keyCode == '40') {
//          if (particleCube != undefined) particlesDisperse(researchTextNParticles, 'research');
//          removeLetters3D();
//          setTimeout(function () {
//              moveLetters3d(letrasResearch);
//          }, 100);
//      }
//      else if (e.keyCode == '37') {
//          if (particleCube != undefined) particlesDisperse(2000, 'disperse');
//          removeLetters3D();
//      }
//      else if (e.keyCode == '39') {
//          if (particleCube != undefined) particlesDisperse(researchTextNParticles, 'research');
//          removeLetters3D();
//          setTimeout(function () {
//              moveLetters3d(letrasDesign);
//          }, 100);
//      }
//  });

  var reticulumNear = 0.2;
  var reticulumFar = 6;
  function initRender() {
    scene = new THREE.Scene();
    renderer = new THREE.WebGLRenderer({antialias: true, preserveDrawingBuffer: true, alpha: true});
    renderer.sortObjects = false;
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(width, height);
    renderer.setClearColor(0xffffff, 0);
    renderer.setViewport(0, 0, width, height);
    renderer.getMaxAnisotropy();
    element = renderer.domElement;
    var container = document.getElementById('container');
    container.appendChild(element);
    camera = new THREE.PerspectiveCamera(60, (width / height), 0.01, 10000000);
    // camera.position.set(-0.8, 1, -0.8);
    camera.position.set(-1.6, 1.5, -1.6);
    // *******************************
    // --- Reticulum ---
    // initiate Reticulum so it loads up 
    Reticulum.init(camera, {
      proximity: false,
      near: reticulumNear, //near factor of the raycaster (shouldn't be negative and should be smaller than the far property)
      far: reticulumFar,
      reticle: {
        visible: true,
        restPoint: 1, //Defines the reticle's resting point when no object has been targeted
        color: 0xcc0000,
        innerRadius: 0.0001,
        outerRadius: 0.003,
        hover: {
          color: 0xcc0000,
          innerRadius: 0.02,
          outerRadius: 0.024,
          speed: 5,
          vibrate: 50 //Set to 0 or [] to disable
        }
      },
      fuse: {
        visible: false,
        duration: 2,
        color: 0x00fff6,
        innerRadius: 0.045,
        outerRadius: 0.06,
        vibrate: 100, //Set to 0 or [] to disable
        clickCancelFuse: false //If users clicks on targeted object fuse is canceled
      }
    });
    scene.add(camera);
    if (window.DeviceOrientationEvent && /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
      isMobile = true;
      effect = new THREE.StereoEffect(renderer);
      effect.setSize(window.innerWidth, window.innerHeight);
      effect.setEyeSeparation = 0.5;
      controls = new THREE.OrbitControls(camera, element);
      controls.target.set(
        camera.position.x + 0.1,
        camera.position.y,
        camera.position.z
      );

      function setOrientationControls(e) {
        if (!e.alpha) {
          return;
        }
        controls = new THREE.DeviceOrientationControls(camera, true);
        controls.connect();
        controls.update();
        element.addEventListener('click', fullscreen, false);
        window.removeEventListener('deviceorientation', setOrientationControls, true);
      }

      window.addEventListener('deviceorientation', setOrientationControls, true);
      controlsdevice = new THREE.DeviceOrientationControls(camera, true);
      controlsdevice.connect();
    } else {
      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.70;
      controls.enableZoom = false;
      controls.target.set(camera.position.x, camera.position.y, camera.position.z + 0.5);          
    }
    addTravelPoints();
    ambientLight = new THREE.AmbientLight(0xffffff);
    // ambientLight.position.set(0, 0.6, 0);
    ambientLight.position.set(0, 1.2, 0);
    scene.add(ambientLight);
    
    if (!isMobile) {
      radicallight = new THREE.PointLight(0xffee66, 0, 2.5, 1);
      //radicallight.position.set(-2.5, 0.8, -2);
      radicallight.position.set(-5, 1.6, -4);
      scene.add(radicallight);
      researchlight = new THREE.PointLight(0xff9999, 0, 2.5, 1);
      //researchlight.position.set(-2.5, 0.8, 0.5);
      researchlight.position.set(-5, 1.6, 1);
      scene.add(researchlight);
      designlight = new THREE.PointLight(0x9999ff, 0, 2.5, 1);
      // designlight.position.set(-2.5, 0.8, 2.5);
      designlight.position.set(-5, 1.6, 5);
      scene.add(designlight);
      screen1Light = new THREE.PointLight(0xffffff, 0, 1, 1);
      //screen1Light.position.set(-0.4, 1, 0.74);
      screen1Light.position.set(-0.8, 1.6, 1.5);
      scene.add(screen1Light);
      screen2Light = new THREE.PointLight(0xffffff, 0, 1, 1);
      //screen2Light.position.set(-0.4, 1, 4.15);
      screen2Light.position.set(-0.8, 1.6, 8);
      scene.add(screen2Light);
    }
    buildShape();
    window.addEventListener('resize', onWindowResize, false);
  }

  function buildShape() {

      var skyGeometry = new THREE.SphereGeometry(20, 32, 32);
      var skyMaterial = new THREE.MeshBasicMaterial({
          map: new THREE.TextureLoader().load('images/sky2.jpg'),
          side: THREE.DoubleSide,
          transparent: true,
          opacity: 1,
          color: 0xFFFFFF,
          depthWrite: true
      });
      sky = new THREE.Mesh(skyGeometry, skyMaterial);
      sky.renderOrder = 0;
      sky.rotation.y = 1.7;
      sky.name = "sky";

      scene.add(sky);

      addModel();
  }

  function particlesDisperse(Particles, path) {
      if (disperseParticles.path != path && particleCube != undefined) {
          if (path != 'disperse') reorderParticles(disperseParticles.nParticles, 'disperse');
          setTimeout(function () {
              reorderParticles(Particles, path)
          }, 100);
      }
  }

  function reorderParticles(Particles, path) {
      if (path == 'radical') {
          if (!particlesAnimation) {
              particleCube.position.set(-2.7, 1, -2.1);
              particleCube.lookAt(camera.position);
              particleCube.geometry.vertices = radicalText.vertices;
              disperseParticles = {nParticles: Particles, path: 'radical'};
          } else if (particlesAnimation) {
              movement({x: -2.7, y: 1, z: -2.1}, particleCube.position, 0, 500, TWEEN.Easing.Back.Out);
              setTimeout(function () {
                  particleCube.lookAt(camera.position);
              }, 100);
              for (var a = 0; a < Particles; a++) {
                  movement({
                      x: radicalText.vertices[a].x,
                      y: radicalText.vertices[a].y,
                      z: radicalText.vertices[a].z
                  }, particleCube.geometry.vertices[a], 0.1 * a, 1000, TWEEN.Easing.Back.Out);
                  if (a == Particles - 1) disperseParticles = {nParticles: Particles, path: 'radical'};
              }
          }
      } else if (path == 'research') {
          if (!particlesAnimation) {
              particleCube.position.set(-2.7, 1, 1);
              particleCube.lookAt(camera.position);
              particleCube.geometry.vertices = researchText.vertices;
              disperseParticles = {nParticles: Particles, path: 'research'};
          } else if (particlesAnimation) {
              movement({x: -2.7, y: 1, z: 1}, particleCube.position, 0, 500, TWEEN.Easing.Back.Out);
              setTimeout(function () {
                  particleCube.lookAt(camera.position);
              }, 100);
              for (var a = 0; a < Particles; a++) {
                  movement({
                      x: researchText.vertices[a].x,
                      y: researchText.vertices[a].y,
                      z: researchText.vertices[a].z
                  }, particleCube.geometry.vertices[a], 0.1 * a, 1000, TWEEN.Easing.Back.Out);
                  if (a == Particles - 1) disperseParticles = {nParticles: Particles, path: 'research'};
              }
          }
      } else if (path == 'disperse') {
          if (!particlesAnimation) {
              particleCube.position.set(0, 0, 0);
              particleCube.geometry.vertices = verticesArray;
              disperseParticles = {nParticles: numeroParticulas, path: 'disperse'};
          } else if (particlesAnimation) {
              movement({x: 0, y: 0, z: 0}, particleCube.position, 0, 500, TWEEN.Easing.Back.Out);
              setTimeout(function () {
                  particleCube.lookAt(camera.position);
              }, 100);
              for (var a = 0; a < Particles; a++) {
                  movement({
                      x: verticesArray[a].x,
                      y: verticesArray[a].y,
                      z: verticesArray[a].z
                  }, particleCube.geometry.vertices[a], 0.1 * a, 1000, TWEEN.Easing.Back.Out);
                  if (a == Particles - 1) disperseParticles = {nParticles: numeroParticulas, path: 'disperse'};
              }
          }
      }
  }

  function addModel() {
      var onProgress = function (xhr) {
        if (xhr.lengthComputable) {
          var percentComplete = xhr.loaded / xhr.total * 100;
          if (percentComplete == 100) {
            setTimeout(function () {
              addScreens();
            }, 1000);
          }
        }
      };
      var onError = function (xhr) {
        console.log('error', xhr)
      };

      // addLetters3D(stringToCharArray("Radical"), {x: -2.7, y: 1, z: -1.7}, letrasRadical);
      addLetters3D(stringToCharArray("Radical"), {x: -5.4, y: 1.6, z: -3.4}, letrasRadical);
      // addLetters3D(stringToCharArray("Research"), {x: -2.7, y: 1, z: 1}, letrasResearch);
      addLetters3D(stringToCharArray("Research"), {x: -5.4, y: 1.6, z: 2}, letrasResearch);
      // addLetters3D(stringToCharArray("Design"), {x: -2.7, y: 1, z: 3}, letrasDesign);
      addLetters3D(stringToCharArray("Design"), {x: -5.4, y: 1.6, z: 6}, letrasDesign);
      // addLetters3D(stringToCharArray("Comunicacion"), {x: -2.7, y: 1, z: 3}, letrasComunicacion);
      addLetters3D(stringToCharArray("Comunicacion"), {x: -5.4, y: 1.6, z:63}, letrasComunicacion);
      // addLetters3D(stringToCharArray("Clever"), {x: -2.7, y: 1, z: 3}, letrasClever);
      addLetters3D(stringToCharArray("Clever"), {x: -5.4, y: 1.6, z: 6}, letrasClever);
      // addLetters3D(stringToCharArray("Maker"), {x: -2.7, y: 1, z: 3}, letrasMaker);
      addLetters3D(stringToCharArray("Maker"), {x: -5.4, y: 1.6, z: 6}, letrasMaker);

      THREE.Loader.Handlers.add(/\.dds$/i, new THREE.DDSLoader());
      var mtlLoader = new THREE.MTLLoader();
      mtlLoader.setPath('models/vrLabsModel/');
      mtlLoader.load('planta6.mtl', function (materials) {
        materials.preload();
        var objLoader = new THREE.OBJLoader();
        objLoader.setMaterials(materials);
        objLoader.setPath('models/vrLabsModel/');
        objLoader.load('planta6.obj', function (elements) {
          techo = elements.children[13];
          techo.renderOrder = 0;
          techo.name = "techo";
          planta.add(techo);
          banco = elements.children[12];
          banco.renderOrder = 0;
          banco.name = "banco";
          planta.add(banco);
          cristaleraEntrada = elements.children[11];
          cristaleraEntrada.renderOrder = 1;
          cristaleraEntrada.name = "cristaleraEntrada";
          planta.add(cristaleraEntrada);
          pared = elements.children[10];
          pared.renderOrder = 0;
          pared.name = "pared";
          planta.add(pared);
          cristaleraAgora = elements.children[9];
          cristaleraAgora.renderOrder = 1;
          cristaleraAgora.name = "cristaleraAgora";
          planta.add(cristaleraAgora);
          centro = elements.children[8];
          centro.renderOrder = 0;
          centro.name = "centro";
          mesas.add(centro);
          research = elements.children[7];
          research.renderOrder = 0;
          research.name = "research";
          mesas.add(research);
          design = elements.children[6];
          design.renderOrder = 0;
          design.name = "design";
          mesas.add(design);
          Reticulum.add( design, {
            reticleHoverColor: 0x00fff6,
            fuseVisible: true,
            onGazeOver: function() {
              // do something when user targets object
              // if (this.material.emissive) this.material.emissive.setHex( 0xffcc00 );
              // addLetters3D(stringToCharArray("Design"), {x: -2.7, y: 1, z: 3}, letrasDesign);
              // moveLetters3d(letrasDesign, activeLetters);
            },
            onGazeOut: function() {
              // do something when user moves reticle off targeted object
              // if (this.material.emissive) this.material.emissive.setHex( 0xcc0000 );
              // removeLetters3D(letrasDesign);
            },
            onGazeLong: function() {
              if (infoGroup.children.length > 0) {
                removeMembers();
                removeInfoSection();
              }
              actualLab = 'design';
              movement({intensity: 2}, designlight, 0, 2000, TWEEN.Easing.Quartic.Out);
              movement({intensity: 0}, radicallight, 0, 2000, TWEEN.Easing.Quartic.Out);
              movement({intensity: 0}, researchlight, 0, 2000, TWEEN.Easing.Quartic.Out);
              movement({intensity: 0.1}, ambientLight, 0, 2000, TWEEN.Easing.Quartic.Out);
              movement({intensity: 0}, screen1Light, 0, 2000, TWEEN.Easing.Quartic.Out);
              movement({intensity: 0}, screen2Light, 0, 2000, TWEEN.Easing.Quartic.Out);
              // movement({x: -0.6, y: 1.1, z: 2.5}, camera.position, 0, 2000, TWEEN.Easing.Quartic.Out);
              movement({x: -1.2, y: 1.5, z: 5}, camera.position, 0, 2000, TWEEN.Easing.Quartic.Out);
              // if (controls) movement({x: -0.7, y: 1, z: 2.5}, controls.target, 0, 2000, TWEEN.Easing.Quartic.Out);
              if (controls) movement({x: -1.4, y: 1.6, z: 5}, controls.target, 0, 2000, TWEEN.Easing.Quartic.Out);
            },
            onGazeClick: function() {
              // have the object react when user clicks / taps on targeted object
              if (this.material.emissive) this.material.emissive.setHex( 0x00cccc * Math.random() );
            }
          });
          comunicacion = elements.children[5];
          comunicacion.renderOrder = 0;
          comunicacion.name = "comunicacion";
          mesas.add(comunicacion);
          Reticulum.add( comunicacion, {
            reticleHoverColor: 0x00fff6,
            fuseVisible: true,
            onGazeOver: function() {
              // do something when user targets object
              // if (this.material.emissive) this.material.emissive.setHex( 0xffcc00 );
              // addLetters3D(stringToCharArray("Comunicacion"), {x: -2.7, y: 1, z: 3}, letrasComunicacion);
              // moveLetters3d(letrasComunicacion, activeLetters);
            },
            onGazeOut: function() {
              // do something when user moves reticle off targeted object
              // if (this.material.emissive) this.material.emissive.setHex( 0xcc0000 );
              // removeLetters3D(letrasComunicacion);
            },
            onGazeLong: function() {
            },
            onGazeClick: function() {
            }
          });
          clever = elements.children[4];
          clever.renderOrder = 0;
          clever.name = "clever";
          mesas.add(clever);
          Reticulum.add( clever, {
            reticleHoverColor: 0x00fff6,
            fuseVisible: true,
            onGazeOver: function() {
              // do something when user targets object
              // if (this.material.emissive) this.material.emissive.setHex( 0xffcc00 );
              // addLetters3D(stringToCharArray("Clever"), {x: -2.7, y: 1, z: 3}, letrasClever);
              // moveLetters3d(letrasClever, activeLetters);
            },
            onGazeOut: function() {
              // do something when user moves reticle off targeted object
              // if (this.material.emissive) this.material.emissive.setHex( 0xcc0000 );
              // removeLetters3D(letrasClever);
            },
            onGazeLong: function() {
            },
            onGazeClick: function() {
            }
          });
          cristaleraFrontal = elements.children[3];
          cristaleraFrontal.renderOrder = 2;
          cristaleraFrontal.name = "cristaleraFrontal";
          planta.add(cristaleraFrontal);
          sillas = elements.children[2];
          sillas.renderOrder = 0;
          sillas.name = "sillas";
          planta.add(sillas);
          maker = elements.children[0];
          maker.renderOrder = 0;
          maker.name = "maker";
          mesas.add(maker);
          Reticulum.add( maker, {
            reticleHoverColor: 0x00fff6,
            fuseVisible: true,
            onGazeOver: function() {
              // addLetters3D(stringToCharArray("Maker"), {x: -2.7, y: 1, z: 3}, letrasMaker);
              addLetters3D(stringToCharArray("Maker"), {x: -5.4, y: 1.6, z: 6}, letrasMaker);
              moveLetters3d(letrasMaker, activeLetters);
            },
            onGazeOut: function() {
              removeLetters3D(letrasMaker);
            },
            onGazeLong: function() {
            },
            onGazeClick: function() {
            }
          });
          planta.add(mesas);
          planta.scale.set(2,2,2);
          scene.add(planta);
        }, onProgress, onError);
      });
  }

  function addExitIcon(position) {
    var objLoader = new THREE.OBJLoader();
    objLoader.setPath('models/');
    objLoader.load('exitModel.obj', function (elements) {
      var exitMaterial = new THREE.MeshBasicMaterial({color: 0xffdd44});
      exitIcon = new THREE.Mesh(elements.children[0].geometry, exitMaterial);
      exitIcon.position.set(position.x, position.y + 1, position.z);
      exitIcon.scale.set(0.1, 0.2, 0.2);
      exitGroup.add(exitIcon);
      scene.add(exitGroup);
      movement({y: position.y}, exitIcon.position, 300, 1000, TWEEN.Easing.Back.Out);
    });
  }

  function addLetters3D(lettersArray, position, object) {
    var loader = new THREE.FontLoader();
    loader.load('scene/fonts/droid_sans_bold.typeface.js', function (font) {
      for (var a = 0; a < lettersArray.length; a++) {
        var radicalTextModel = new THREE.TextGeometry(lettersArray[a], {
          font: font,
          size: 0.05,
          height: 0.01,
          curveSegments: 3,
          bevelEnabled: true,
          bevelThickness: 0.01,
          bevelSize: 0.01
        });
        var materialFront = new THREE.MeshBasicMaterial({color: 0xffdd44});
        var materialSide = new THREE.MeshBasicMaterial({color: 0x333333});
        var materialArray = [materialFront, materialSide];
        var textMaterial = new THREE.MeshFaceMaterial(materialArray);
        var radicalTextMesh = new THREE.Mesh(radicalTextModel, textMaterial);
        radicalTextMesh.position.x = 0.1 * a;
        radicalTextMesh.position.y = -2;
        radicalTextModel.computeBoundingBox();
        object.add(radicalTextMesh);
      }
    });
    object.position.set(position.x, position.y, position.z);
    object.lookAt(camera.position);
    object.name = 'letras3D';
    scene.add(object);
  }

  function addParticleSystem() {
      var loader = new THREE.FontLoader();
      loader.load('scene/fonts/droid_sans_bold.typeface.js', function (font) {
          radicalText = new THREE.TextGeometry('CreativeTech + UX + Mobility', {
              font: font,
              size: 0.1,
              height: 0,
              curveSegments: 1
          });
          researchText = new THREE.TextGeometry('Research', {
              font: font,
              size: 0.1,
              height: 0,
              curveSegments: 1
          });
          var modifier = new THREE.SubdivisionModifier(1);
          modifier.modify(radicalText);
          modifier.modify(researchText);
          radicalTextNParticles = radicalText.vertices.length;
          researchTextNParticles = researchText.vertices.length;
      });
      var boxGeometry = new THREE.Geometry();
      for (var p = 0; p < numeroParticulas; p++) {
          var pX = Math.random() * (max - min + 1) + min,
              pY = Math.random() * (max - min + 1) + min,
              pZ = Math.random() * (max - min + 1) + min,
              particle = new THREE.Vector3(pX, pY, pZ);
          verticesArray.push({x: pX, y: pY, z: pZ});
          boxGeometry.vertices.push(particle);
      }
      var particleMaterial = new THREE.ParticleBasicMaterial({
          size: 0.02,
          color: 0x333333,
          transparency: true,
          opacity: 0.5
      });
      particleCube = new THREE.Points(boxGeometry, particleMaterial);
      particleCube.position.set(0, 0, 0);
      scene.add(particleCube);
  }

  function addSpritesLetters(lettersArray) {
    for (var a = 0; a < lettersArray.length; a++) {
      var map = new THREE.TextureLoader().load("images/letters/" + lettersArray[a] + ".png");
      var material = new THREE.SpriteMaterial({map: map, color: 0xffffff, fog: true});
      var sprite = new THREE.Sprite(material);
      if (isMobile) {
        sprite.position.x = 0.03 * a;
        sprite.position.z = -1.5;
        sprite.scale.set(0.03, 0.03, 0.03);
        spriteGroup.add(sprite);
        spriteGroup.position.x = -0.13;
        spriteGroup.position.y = -0.06;
      }
      else {
        sprite.position.x = 0.04 * a;
        sprite.position.z = -0.5;
        sprite.scale.set(0.05, 0.05, 0.05);
        spriteGroup.add(sprite);
        spriteGroup.position.x = -0.6;
        spriteGroup.position.y = -0.25;
      }
      camera.add(spriteGroup);
    }
  }

  function removeSpriteLetters() {
      camera.remove(spriteGroup);
      spriteGroup = new THREE.Object3D();
      spriteGroup.name = 'spriteGroup';
  }

  function addScreens() {

    videoMP4 = document.createElement('video').canPlayType('video/mp4') !== '';
    videoOgg = document.createElement('video').canPlayType('video/ogg') !== '';
    var url, url2;
    if (videoMP4) {
        url = 'videos/sintel.mp4';
        url2 = 'videos/salchis.mp4';
    } else if (videoOgg) {
        url = 'videos/sintel.ogv';
        url2 = 'videos/salchis.mp4';
    } else {
      alert('cant play mp4 or ogv');
    }
    videoTexture = new THREEx.VideoTexture(url);
    videoTexture.needsUpdate = false;
    video = videoTexture.video;
    videoTexture2 = new THREEx.VideoTexture(url2);
    videoTexture2.needsUpdate = false;
    video2 = videoTexture2.video;
    video.pause();
    video2.pause();
    
    addScreen1();
    addScreen2();

    scene.add(screensGroup);
    $("#allowVideo").css('display', 'block');
  }

  function addScreen1() {
    if (screen1Mesh == undefined) {
      // var screen1Geometry = new THREE.PlaneGeometry(0.4, 0.25, 1, 1);
      var screen1Geometry = new THREE.PlaneGeometry(0.8, 0.5, 2, 1);
      var screen1Material = new THREE.MeshBasicMaterial({
        map: videoTexture.texture,
        side: THREE.DoubleSide
      });
      screen1Mesh = new THREE.Mesh(screen1Geometry, screen1Material);
      // screen1Mesh.position.set(-0.225, 1.13, 0.74);
      screen1Mesh.position.set(-0.45, 2, 1.5);
      screen1Mesh.rotateY(-Math.PI / 2);
      screen1Mesh.name = 'screen1';
    }
    
    Reticulum.add( screen1Mesh, {
      reticleHoverColor: 0x00fff6,
      fuseVisible: true,
      onGazeOver: function() {
        if (this.material.emissive) this.material.emissive.setHex( 0xffcc00 );
      },
      onGazeOut: function() {
        if (this.material.emissive) this.material.emissive.setHex( 0xcc0000 );
      },
      onGazeLong: function() {
        removeFromReticulum(screen1Mesh);
        if (video != undefined && video2 != undefined) {
          video2.pause();
          // if (controls) controls.target.set(screen1Mesh.position.x - 0.1, screen1Mesh.position.y, screen1Mesh.position.z);
          if (controls) controls.target.set(screen1Mesh.position.x - 0.2, screen1Mesh.position.y, screen1Mesh.position.z);
          // movement({x: -0.7, y: 1, z: screen1Mesh.position.z}, camera.position, 0, 2000, TWEEN.Easing.Quartic.Out, addMediaControls(screen1Mesh, video));
          movement({x: -1.5, y: 2, z: screen1Mesh.position.z}, camera.position, 0, 2000, TWEEN.Easing.Quartic.Out, addMediaControls(screen1Mesh, video));
        }
        camera.up = new THREE.Vector3(0,1,0);
        camera.lookAt(screen1Mesh.position);
      }
    });
    screensGroup.add(screen1Mesh);
  }

  function addScreen2() {
    // var screen2Geometry = new THREE.PlaneGeometry(0.4, 0.25, 1, 1);
    var screen2Geometry = new THREE.PlaneGeometry(0.8, 0.5, 2, 1);
    var screen2Material = new THREE.MeshBasicMaterial({
      map: videoTexture.texture,
      side: THREE.DoubleSide
    });
    screen2Mesh = new THREE.Mesh(screen2Geometry, screen2Material);
    // screen2Mesh.position.set(-0.225, 1.13, 4.15);
    screen2Mesh.position.set(-0.45, 2, 8.3);
    screen2Mesh.rotateY(-Math.PI / 2);
    screen2Mesh.name = 'screen2';
    
    Reticulum.add( screen2Mesh, {
      reticleHoverColor: 0x00fff6,
      fuseVisible: true,
      onGazeOver: function() {
        // do something when user targets object
        if (this.material.emissive) this.material.emissive.setHex( 0xffcc00 );
      },
      onGazeOut: function() {
        // do something when user moves reticle off targeted object
        if (this.material.emissive) this.material.emissive.setHex( 0xcc0000 );
      },
      onGazeLong: function() {
        removeFromReticulum(screen2Mesh);
        if (video != undefined && video2 != undefined) {
          video.pause();
          // if (controls) controls.target.set(screen2Mesh.position.x - 0.1, screen2Mesh.position.y, screen2Mesh.position.z);
          if (controls) controls.target.set(screen2Mesh.position.x - 0.2, screen2Mesh.position.y, screen2Mesh.position.z);
          // movement({x: -0.7, y: 1, z: screen2Mesh.position.z}, camera.position, 0, 2000, TWEEN.Easing.Quartic.Out, addMediaControls(screen2Mesh, video2));
          movement({x: -1.4, y: 2, z: screen2Mesh.position.z}, camera.position, 0, 2000, TWEEN.Easing.Quartic.Out, addMediaControls(screen2Mesh, video2));
        }
        camera.up = new THREE.Vector3(0,1,0);
        camera.lookAt(screen2Mesh.position);
      }
    });
    screensGroup.add(screen2Mesh);
  }

  function removeFromReticulum(meshObject) {
    Reticulum.remove(meshObject);
  }

  var mediaControlsContainer;
  function addMediaControls(object, video) {
    mediaControlsContainer = new THREE.Object3D();
    // mediaControlsContainer.position.set(-0.25, object.position.y-0.1, object.position.z);
    mediaControlsContainer.position.set(object.position.x, object.position.y, object.position.z);

    mediaControlsContainer.rotateY(-Math.PI / 2);
    var mediaControls = [
      // {name: 'media-stop', path: 'stop.png', position: {x: -0.08, y: 0, z: 0}},
      {name: 'media-stop', path: 'stop.png', position: {x: 0, y: 0, z: -1}},
      // {name: 'media-pause', path: 'pause.png', position: {x: 0, y: 0, z: 0}},
      {name: 'media-pause', path: 'pause.png', position: {x: 0, y: 0, z: -1}},
      // {name: 'media-close', path: 'close.png', position: {x: 0.15, y: 0.2, z: 0}}
      {name: 'media-close', path: 'close.png', position: {x: 0, y: 0, z: -1}},
      // {name: 'media-play', path: 'play.png', position: {x: -0.15, y: 0, z: 0}}
      {name: 'media-play', path: 'play.png', position: {x: 0, y: 0, z: 0}}
    ];
    for (var i = 0; i < mediaControls.length; i++) {
      addMediaButton(mediaControls[i].name, mediaControls[i].path, mediaControls[i].position, video);
    }
    scene.add(mediaControlsContainer)
  }

  function showMediaControls() {
    movement({x: -0.3, y: 0, z: 0.1}, playButton.position, 0, 500, TWEEN.Easing.Back.Out);
    movement({x: -0.16, y: 0, z: 0.1}, stopButton.position, 0, 500, TWEEN.Easing.Back.Out);
    movement({x: 0, y: 0, z: 0.1}, pauseButton.position, 0, 500, TWEEN.Easing.Back.Out);
    movement({x: 0.16, y: 0, z: 0.1}, closeButton.position, 0, 500, TWEEN.Easing.Back.Out);
    movement({x: screen1Mesh.position.x, y: screen1Mesh.position.y - 0.3, z: screen1Mesh.position.z + 0.1}, mediaControlsContainer.position, 0, 1500, TWEEN.Easing.Back.Out)
  }

  var cameraLookingAtScreenRotationValue;
  function saveCameraLookingAtScreenRotationValue() {
    cameraLookingAtScreenRotationValue = new THREE.Object3D();
    cameraLookingAtScreenRotationValue.rotation.copy(camera.rotation);
  }

  var playButton, stopButton, pauseButton, fastForwardButton, rewindButton, closeButton;
  var videoPlaying = true;
  function addMediaButton(name, path, position, videoObject) {
    var img = new THREE.MeshBasicMaterial({
      map:THREE.ImageUtils.loadTexture("images/mediaControls/" + path),
      transparent: true,
      side: THREE.DoubleSide
    });
    img.map.needsUpdate = true;

    // var scale = 0.05;
    var scale = 0.1;
    var plane = new THREE.Mesh(new THREE.PlaneGeometry(scale, scale), img);
    plane.name = name;
    // plane.rotateY(-Math.PI / 2);
    plane.position.set(position.x, position.y, position.z);
    if (name === 'media-play') {
      playButton = plane;
    } else if (name === 'media-stop') {
      stopButton = plane;
    } else if (name === 'media-pause') {
      pauseButton = plane;
    } else if (name === 'media-close') {
      closeButton = plane;
    }
    mediaControlsContainer.add(plane);

    Reticulum.add( plane, {
      reticleHoverColor: 0x00fff6,
      fuseVisible: true,
      onGazeOver: function() {
        if (this.material.color) this.material.color.setHex( 0xffcc00 );
      },
      onGazeOut: function() {
        if (this.material.color) this.material.color.setHex( 0xffffff );
      },
      onGazeLong: function() {
        if (name === 'media-play') {
          showMediaControls();
          videoObject.play();
          videoPlaying = true;
          saveCameraLookingAtScreenRotationValue();
        } else if (name === 'media-close') {
          videoObject.pause();
          removeMediaControls();
          exitScreen(videoObject);
          videoPlaying = false;
        } else {
          videoObject.pause();
          videoPlaying = false;
        }
      },
      onGazeClick: function() {
      }
    });
  }

  function removeMediaControls() {
    scene.remove(mediaControlsContainer);
  }

  function exitScreen(videoObject) {
    if (videoObject === video) {
      // move to research lab
      // movement({x: -1.2, y: 1, z: 1.8}, camera.position, 0, 2000, TWEEN.Easing.Quartic.Out);
      movement({x: -2.4, y: 1.6, z: 3.6}, camera.position, 0, 2000, TWEEN.Easing.Quartic.Out);
      // if (controls) controls.target.set(0.1, 0.5, researchLabel.position.z);
      if (controls) controls.target.set(0.2, 1, researchLabel.position.z);
    } else if (videoObject === video2) {
      // move to tvPoint
      // movement({x: -0.6, y: 1, z: 2.5}, camera.position, 0, 2000, TWEEN.Easing.Quartic.Out);
      movement({x: -1.2, y: 1.6, z: 5}, camera.position, 0, 2000, TWEEN.Easing.Quartic.Out);
      // if (controls) controls.target.set(-0.9, 1, 2.5);
      if (controls) controls.target.set(-1.8, 1.6, 5);
    }
  }

  function stringToCharArray(string) {
    var result = string.split('');
    for (var i = 0; i < result.length; i++) {
      if (result[i] == ' ') result[i] = 'blanck';
      if (result[i] == '+') result[i] = 'plus';
    }
    return result;
  }

  function addTravelPoints() {
    var locationPoints = [
      // {name: 'makerPoint', position: {x: -1, y: 0.5, z: -3.5}}, 
      {name: 'makerPoint', position: {x: -2, y: 1, z: -7}}, 
      // {name: 'tvPoint', position: {x: -1, y: 0.5, z: 2.5}}, 
      {name: 'tvPoint', position: {x: -2, y: 1, z: 5}}, 
      // {name: 'radical', position: {x: -1.5, y: 0.6, z: -1.5}},
      {name: 'radical', position: {x: -3, y: 1.2, z: -3}},
      // {name: 'research', position: {x: -1.3, y: 0.6, z: 0.5}}
      {name: 'research', position: {x: -2.6, y: 1.2, z: 1}}
    ];

    for (var i = 0; i < locationPoints.length - 1; i++) {
      if (i < 2) {
        addTravelPoint(locationPoints[i].name, locationPoints[i].position);
      } else {
        addLabel(locationPoints[i].name, locationPoints[i].position);
      }
    }

    addLabel(locationPoints[locationPoints.length - 1].name, locationPoints[locationPoints.length - 1].position);
  }

  function toTitleCase(str) {
    return str.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
  }

  var researchLabel;
  var radicalLabel;
  function addLabel(name, position) {
    var img = new THREE.MeshBasicMaterial({ //CHANGED to MeshBasicMaterial
        map:THREE.ImageUtils.loadTexture("images/labelLabs"+ toTitleCase(name) +".png"),
        transparent: true,
        color: 0xffffff
    });
    img.map.needsUpdate = true; //ADDED

    var scale = 0.6;
    var plane = new THREE.Mesh(new THREE.PlaneGeometry(scale, scale/4), img);
    plane.name = name;
    plane.position.set(position.x, position.y, position.z);
    if (name === 'research') {
      researchLabel = plane;
    } else if (name === 'radical') {
      radicalLabel = plane;
    }
    scene.add(plane);

    Reticulum.add( plane, {
      reticleHoverColor: 0x00fff6,
      fuseVisible: true,
      onGazeOver: function() {
        
      },
      onGazeOut: function() {
        // do something when user moves reticle off targeted object
        
      },
      onGazeLong: function() {
        removeMembers();
        removeInfoSection();
        if (name === 'research') {
          addMembers(researchMembers);
          actualLab = 'research';
          checkstatus.screens = false;
          movement({intensity: 2}, researchlight, 0, 2000, TWEEN.Easing.Quartic.Out);
          movement({intensity: 0}, radicallight, 0, 2000, TWEEN.Easing.Quartic.Out);
          movement({intensity: 0}, designlight, 0, 2000, TWEEN.Easing.Quartic.Out);
          movement({intensity: 0.1}, ambientLight, 0, 2000, TWEEN.Easing.Quartic.Out);
          movement({intensity: 0}, screen1Light, 0, 2000, TWEEN.Easing.Quartic.Out);
          movement({intensity: 0}, screen2Light, 0, 2000, TWEEN.Easing.Quartic.Out);
          // movement({x: -0.6, y: 1, z: 0.8}, camera.position, 0, 2000, TWEEN.Easing.Quartic.Out);
          movement({x: -1.2, y: 1.6, z: 1.6}, camera.position, 0, 2000, TWEEN.Easing.Quartic.Out);
        } else if (name === 'radical') {
          addMembers(radicalMembers);
          actualLab = 'centro';
          checkstatus.screens = false;
          movement({intensity: 0}, researchlight, 0, 2000, TWEEN.Easing.Quartic.Out);
          movement({intensity: 2}, radicallight, 0, 2000, TWEEN.Easing.Quartic.Out);
          movement({intensity: 0}, designlight, 0, 2000, TWEEN.Easing.Quartic.Out);
          movement({intensity: 0.1}, ambientLight, 0, 2000, TWEEN.Easing.Quartic.Out);
          movement({intensity: 0}, screen1Light, 0, 2000, TWEEN.Easing.Quartic.Out);
          movement({intensity: 0}, screen2Light, 0, 2000, TWEEN.Easing.Quartic.Out);
          //movement({x: -0.6, y: 1, z: -2}, camera.position, 0, 2000, TWEEN.Easing.Quartic.Out);
          movement({x: -1.2, y: 1.6, z: -4}, camera.position, 0, 2000, TWEEN.Easing.Quartic.Out);
        }
        
        //if (controls) controls.target.set(plane.position.x + 0.1, 1, plane.position.z);
        if (controls) controls.target.set(plane.position.x + 0.2, 2, plane.position.z);
      },
      onGazeClick: function() {
        // have the object react when user clicks / taps on targeted object
      }
    });
  }

  function addTravelPoint(name, position) {
    var objLoader = new THREE.OBJLoader();
    objLoader.setPath('models/');
    objLoader.load('arrow.obj', function (elements) {
      arrowIconGeometry = elements.children[0].geometry;
      var geometry = arrowIconGeometry;
      var material = new THREE.MeshBasicMaterial({color: 0xffdd44});
      var cube = new THREE.Mesh(geometry, material);
      cube.position.set(position.x, position.y, position.z);        
      
      cube.name = name;
      // rotacion
      var xAxis = new THREE.Vector3(1,0,0);
      var yAxis = new THREE.Vector3(0,1,0);
      var zAxis = new THREE.Vector3(0,0,1);
      rotateAroundWorldAxis(cube, xAxis, 180 * Math.PI / 180);
      rotateAroundWorldAxis(cube, yAxis, 120 * Math.PI / 180);
      rotateAroundWorldAxis(cube, zAxis, 90 * Math.PI / 180);
      scene.add(cube);

      Reticulum.add( cube, {
        reticleHoverColor: 0x00fff6,
        fuseVisible: true,
        onGazeOver: function() {
          // if (cube.name == 'makerPoint') addSpritesLetters(stringToCharArray("maker space"));
          // if (cube.name == 'tvPoint') addSpritesLetters(stringToCharArray("videos"));
          if (cube.name == 'radical') {
            addLetters3D(stringToCharArray("Radical"), {x: cube.position.x, y: cube.position.y, z: cube.position.z}, letrasRadical);
            moveLetters3d(letrasRadical, activeLetters);
          }
          if (cube.name == 'research') {
            addLetters3D(stringToCharArray("Research"), {x: cube.position.x, y: cube.position.y, z: cube.position.z}, letrasResearch);
            moveLetters3d(letrasResearch, activeLetters);
          }
        },
        onGazeOut: function() {
          // do something when user moves reticle off targeted object
          if (cube.name == 'radical') {
            removeLetters3D(letrasRadical);
          } else if (cube.name == 'research') {
            removeLetters3D(letrasResearch);
          }
        },
        onGazeLong: function() {
          // do something user targetes object for specific time
          if (infoGroup.children.length > 0) {
            removeMembers();
            removeInfoSection();
          }
          movement({intensity: 0}, radicallight, 0, 2000, TWEEN.Easing.Quartic.Out);
          movement({intensity: 0}, researchlight, 0, 2000, TWEEN.Easing.Quartic.Out);
          movement({intensity: 0}, designlight, 0, 2000, TWEEN.Easing.Quartic.Out);
          movement({intensity: 0}, screen1Light, 0, 2000, TWEEN.Easing.Quartic.Out);
          movement({intensity: 0}, screen2Light, 0, 2000, TWEEN.Easing.Quartic.Out);
          movement({intensity: 1}, ambientLight, 0, 2000, TWEEN.Easing.Quartic.Out);
          // movement({x: -0.6, y: 1, z: cube.position.z}, camera.position, 0, 2000, TWEEN.Easing.Quartic.Out);
          movement({x: -1.2, y: 2, z: cube.position.z}, camera.position, 0, 2000, TWEEN.Easing.Quartic.Out);
          if (cube.name == 'tvPoint') {
            checkstatus.screens = true;
          } else {
            checkstatus.screens = false;
          }
          // if (controls) controls.target.set(cube.position.x + 0.1, 1, cube.position.z);
          if (controls) controls.target.set(cube.position.x + 0.2, 2, cube.position.z);
        },
        onGazeClick: function() {
          // have the object react when user clicks / taps on targeted object
        }
      });
    });
  }

  var rotWorldMatrix;
  // Rotate an object around an arbitrary axis in world space       
  function rotateAroundWorldAxis(object, axis, radians) {
    rotWorldMatrix = new THREE.Matrix4();
    rotWorldMatrix.makeRotationAxis(axis.normalize(), radians);

    rotWorldMatrix.multiply(object.matrix);

    object.matrix = rotWorldMatrix;

    object.rotation.setFromRotationMatrix(object.matrix);
  }

  var memberPlanes = [];
  function addMembers(members) {
    checkstatus.mesas = false;
    for (var i = 0; i < members.length; i++) {
      addMember(members[i], i);
    }
    scene.add(membersGroup);
  }

  function addMember(member, index) {
    var img = new THREE.MeshBasicMaterial({ //CHANGED to MeshBasicMaterial
      map:THREE.ImageUtils.loadTexture("images/membersPhoto/" + member.name + ".png"),
      transparent: true,
      depthWrite: false,
      color: 0xffffff
    });
    img.map.needsUpdate = true; //ADDED

    //var plane = new THREE.Mesh(new THREE.PlaneGeometry(0.5, 0.5), img);
    var plane = new THREE.Mesh(new THREE.PlaneGeometry(0.9, 0.9), img);
    plane.name = member.name;
    plane.position.set(member.position.x, member.position.y, member.position.z);
    membersGroup.add(plane);
    movement({y: member.position.y}, plane.position, 300 * index, 500, TWEEN.Easing.Back.Out);
    memberPlanes.push(plane);
    scene.add(plane);

    Reticulum.add( plane, {
      reticleHoverColor: 0x00fff6,
      fuseVisible: true,
      onGazeOver: function() {
        // do something when user targets object
        if (this.material.color) this.material.color.setHex( 0xffcc00 );
      },
      onGazeOut: function() {
        // do something when user moves reticle off targeted object
        if (this.material.color) this.material.color.setHex( 0xffffff );
      },
      onGazeLong: function() {
        if (plane.name == 'sergio_recortada') addInfoSection(sergioInfoImages, 'sergioInfo', 300);
      },
      onGazeClick: function() {
        // do something
      }
    });
  }

  function removeMembers() {
    var numberOfMembers = membersGroup.children.length;
    for (var a = 0; a < numberOfMembers; a++) {
      // movement({y: -2}, membersGroup.children[a].position, 0, 500, TWEEN.Easing.Back.In);
      movement({y: -4}, membersGroup.children[a].position, 0, 500, TWEEN.Easing.Back.In);
      scene.remove(membersGroup.children[a]);
      if (a == numberOfMembers - 1) {
        membersGroup = new THREE.Object3D();
        membersGroup.name = 'members';
      }
    }
  }

  function addInfoSection(images, name, timeout) {
      sectionInfoAdded = true;
      if (infoGroup.children.length > 0) {
          hideInfo();
      }
      scene.remove(infoGroup);
      infoGroup = new THREE.Object3D();
      infoGroup.name = 'infoGroup';
      for (var a = 0; a < 3; a++) {
        var texture = THREE.ImageUtils.loadTexture("images/sectionInfo/" + images[a] + ".png");
        var geometry = new THREE.PlaneGeometry(1, 0.6, 1);
        var material = new THREE.MeshBasicMaterial({
            map: texture,
            transparent: true,
            opacity: 1,
            color: 0xffffff
        });
        var plane = new THREE.Mesh(geometry, material);
        plane.name = name;
        infoGroup.add(plane);
      }
      infoGroup.position.set(-2.3, 0.35 - 2, -1.95);
      infoGroup.rotation.y = Math.PI / 2;
      movement({y: 0.35}, infoGroup.position, 1, 500, TWEEN.Easing.Back.Out);
      scene.add(infoGroup);
  }

  function openInfo() {
      checkstatus.members = false;
      checkstatus.infoCard = false;
      removeSpriteLetters();
      if (infoGroup !== undefined) {
        movement({y: 1}, infoGroup.position, 1, 500, TWEEN.Easing.Back.Out);
        movement({x: -1.8}, infoGroup.position, 1, 500, TWEEN.Easing.Quartic.Out);
        setTimeout(function () {
          if (infoGroup.children !== undefined && infoGroup.children.length > 1) {
            movement({x: 1}, infoGroup.children[1].position, 1, 1000, TWEEN.Easing.Quartic.Out);
            movement({x: -1}, infoGroup.children[2].position, 1, 1000, TWEEN.Easing.Quartic.Out);
          }
        }, 700);
        setTimeout(function () {
          if (infoGroup.children !== undefined && infoGroup.children.length > 1) {
            movement({x: 0.77}, infoGroup.children[1].position, 1, 1000, TWEEN.Easing.Quartic.Out);
            movement({y: -1}, infoGroup.children[1].rotation, 1, 1000, TWEEN.Easing.Quartic.Out);
            movement({z: 0.42}, infoGroup.children[1].position, 1, 1000, TWEEN.Easing.Quartic.Out);
            movement({x: -0.77}, infoGroup.children[2].position, 1, 1000, TWEEN.Easing.Quartic.Out);
            movement({y: 1}, infoGroup.children[2].rotation, 1, 1000, TWEEN.Easing.Quartic.Out);
            movement({z: 0.42}, infoGroup.children[2].position, 1, 1000, TWEEN.Easing.Quartic.Out);
          }
          addExitIcon({x: -1.7, y: 0.5, z: -1.95});
        }, 1700);
      }
  }

  function hideInfo() {
      checkstatus.members = true;
      checkstatus.infoCard = true;
      if (exitGroup !== undefined && exitGroup.children !== undefined && exitGroup.children.length > 0) {
        movement({y: exitIcon.position.y - 1}, exitIcon.position, 1, 500, TWEEN.Easing.Quartic.Out);
      }
      if (infoGroup !== undefined && infoGroup.children !== undefined && infoGroup.children.length >= 2) {
        if (infoGroup.children[1].position.x > 0) movement({x: 1}, infoGroup.children[1].position, 1, 1000, TWEEN.Easing.Quartic.Out);
        movement({y: 0}, infoGroup.children[1].rotation, 1, 1000, TWEEN.Easing.Quartic.Out);
        movement({z: -0.01}, infoGroup.children[1].position, 1, 1000, TWEEN.Easing.Quartic.Out);
        if (infoGroup.children[2].position.x < 0) movement({x: -1}, infoGroup.children[2].position, 1, 1000, TWEEN.Easing.Quartic.Out);
        movement({y: 0}, infoGroup.children[2].rotation, 1, 1000, TWEEN.Easing.Quartic.Out);
        movement({z: 0.01}, infoGroup.children[2].position, 1, 1000, TWEEN.Easing.Quartic.Out);
        setTimeout(function () {
            movement({x: 0}, infoGroup.children[1].position, 1, 1000, TWEEN.Easing.Quartic.Out);
            movement({x: 0}, infoGroup.children[2].position, 1, 1000, TWEEN.Easing.Quartic.Out);
        }, 1000)
        setTimeout(function () {
            movement({y: 0.35}, infoGroup.position, 500, 500, TWEEN.Easing.Back.Out);
            movement({x: -2.3}, infoGroup.position, 0, 500, TWEEN.Easing.Quartic.Out);
            scene.remove(exitGroup);
        }, 2200);
      }
  }

  function removeInfoSection() {
      hideInfo();
      movement({y: -1}, infoGroup.position, 1200, 500, TWEEN.Easing.Back.In);
      setTimeout(function () {
          scene.remove(infoGroup);
          infoGroup = new THREE.Object3D();
          infoGroup.name = 'infoGroup';
          sectionInfoAdded = false;
      }, 1300);
  }

  function moveLetters3d(object, prevObject) {
      for (var a = 0; a < 12; a++) {
          if (prevObject != undefined && prevObject.children[a]) new TWEEN.Tween(prevObject.children[a].position).to({y: -1.5}, 100).easing(TWEEN.Easing.Quartic.Out).onUpdate(function () {
          }).delay(10 * a).start();
          if (object != undefined && object.children[a]) new TWEEN.Tween(object.children[a].position).to({y: 0.2}, 100).easing(TWEEN.Easing.Back.Out).onUpdate(function () {
          }).delay(10 * a).start();
      }
      if (object != undefined) object.lookAt(camera.position);
  }

  function removeLetters3D(object) {
      if (object != undefined) {
          for (var a = 0; a < object.children.length; a++) {
              if (tweenLettersIn != undefined) tweenLettersIn.stop();
              new TWEEN.Tween(object.children[a].position).to({y: -1.5}, 100).easing(TWEEN.Easing.Quartic.Out).onUpdate(function () {
              }).delay(50 * a).start();
          }
      }
  }

  function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
      if (effect != undefined) effect.setSize(window.innerWidth, window.innerHeight);
  }

  function animate() {

      requestAnimationFrame(animate);

      // --- Reticulum ---
      // keep checking if user is looking at any tracked objects
      Reticulum.update();

      render();

      TWEEN.update();

      if (controls) controls.update(clock.getDelta());
      if (controlsdevice) {
        controlsdevice.update();
      }
  }

  var controlsAreMoving = false;
  var controlsAreCentered = false;
  function render() {
    if (effect) {
      try {
          effect.render(scene, camera);
      } catch (TypeError) {
          // console.log('TypeError');
      }
    }
    else {
      renderer.render(scene, camera);
    }
    sky.rotation.y += 0.0003;
    if (particleCube != undefined) {
      particleCube.geometry.verticesNeedUpdate = true;
    }
    if (videoTexture != undefined) videoTexture.update();
    if (videoTexture2 != undefined) videoTexture2.update();
    if (travelPoints.children[0]) travelPoints.children[0].rotation.y += 0.01;
    if (travelPoints.children[1]) travelPoints.children[1].rotation.y += 0.01;
    if (travelPoints.children[2]) travelPoints.children[2].rotation.y += 0.01;

    if (memberPlanes.length > 0) {
      for (var i = 0; i < memberPlanes.length; i++) {
        memberPlanes[i].lookAt(camera.position);
      }
    }
    if (researchLabel !== undefined) {
      researchLabel.lookAt(camera.position);
    }
    if (radicalLabel !== undefined) {
      radicalLabel.lookAt(camera.position);
    }

    if (videoPlaying && cameraLookingAtScreenRotationValue != undefined) {
      if (!controlsAreMoving) {
        console.log(cameraLookingAtScreenRotationValue.rotation.z);
        if (camera.rotation.z < -1.4 && !controlsAreCentered) {
          controlsAreMoving = true;
          movement({x: screen1Mesh.position.x, y: screen1Mesh.position.y, z: screen1Mesh.position.z + 0.1}, mediaControlsContainer.position, 0, 500, TWEEN.Easing.Back.Out, function () {
            controlsAreMoving = false;
            controlsAreCentered = true;
          });
        } else if (camera.rotation.z > cameraLookingAtScreenRotationValue.rotation.z && controlsAreCentered && !controlsAreMoving) {
          controlsAreMoving = true;
          movement({x: screen1Mesh.position.x, y: screen1Mesh.position.y - 0.3, z: screen1Mesh.position.z + 0.1}, mediaControlsContainer.position, 0, 500, TWEEN.Easing.Back.Out, function () {
            controlsAreMoving = false;
            controlsAreCentered = false;
          });
        }
      }
    }
  }

  function movement(value, object, delay, duration, easingType, callback) {
    //var easingType = TWEEN.Easing.Back.Out;
    var tween = new TWEEN.Tween(object)
      .to(value, duration)
      .easing(easingType)
      .delay(delay)
      .onComplete(function () {
        if (callback) {
          callback();
        }
      })
      .start();
  }

  function textSprite(text) {
    var font = "Helvetica",
        size = 1,
        color = "#676767";

    font = "bold " + size + "px " + font;

    var canvas = document.createElement('canvas');
    var context = canvas.getContext('2d');
    context.font = font;

    // get size data (height depends only on font size)
    var metrics = context.measureText(text),
        textWidth = metrics.width;

    canvas.width = textWidth + 1;
    canvas.height = size + 3;

    context.font = font;
    context.fillStyle = color;
    context.fillText(text, 0, size + 3);

    // canvas contents will be used for a texture
    var texture = new THREE.Texture(canvas);
    texture.needsUpdate = true;

    var mesh = new THREE.Mesh(
    new THREE.PlaneGeometry(canvas.width, canvas.height),
    new THREE.MeshBasicMaterial({
        map: texture,
        side: THREE.DoubleSide
    }));

    return mesh;
  }

  function makeTextSprite( message, parameters ) {
    if ( parameters === undefined ) parameters = {};
    var fontface = parameters.hasOwnProperty("fontface") ? parameters["fontface"] : "Arial";
    var fontsize = parameters.hasOwnProperty("fontsize") ? parameters["fontsize"] : 18;
    var position = parameters.hasOwnProperty("position") ? parameters["position"] : {x: 0, y: 0, z: 0};
    var borderThickness = parameters.hasOwnProperty("borderThickness") ? parameters["borderThickness"] : 4;
    var borderColor = parameters.hasOwnProperty("borderColor") ?parameters["borderColor"] : { r:0, g:0, b:0, a:1.0 };
    var backgroundColor = parameters.hasOwnProperty("backgroundColor") ?parameters["backgroundColor"] : { r:255, g:255, b:255, a:1.0 };
    var textColor = parameters.hasOwnProperty("textColor") ?parameters["textColor"] : { r:0, g:0, b:0, a:1.0 };    
    var canvas = document.createElement('canvas');
    var context = canvas.getContext('2d');
    context.font = "Bold " + fontsize + "px " + fontface;
    var metrics = context.measureText( message );
    var textWidth = metrics.width;    
    context.fillStyle   = "rgba(" + backgroundColor.r + "," + backgroundColor.g + "," + backgroundColor.b + "," + backgroundColor.a + ")";
    context.strokeStyle = "rgba(" + borderColor.r + "," + borderColor.g + "," + borderColor.b + "," + borderColor.a + ")";    
    context.lineWidth = borderThickness;
    roundRect(context, borderThickness/2, borderThickness/2, (textWidth + borderThickness) * 1.1, fontsize * 1.4 + borderThickness, 8);    
    context.fillStyle = "rgba("+textColor.r+", "+textColor.g+", "+textColor.b+", 1.0)";
    context.fillText( message, borderThickness, fontsize + borderThickness);    
    var texture = new THREE.Texture(canvas) 
    texture.needsUpdate = true;    
    var spriteMaterial = new THREE.SpriteMaterial( { map: texture, useScreenCoordinates: true } );
    var sprite = new THREE.Sprite( spriteMaterial );
    sprite.scale.set(0.5 * fontsize, 0.25 * fontsize, 0.75 * fontsize);
    sprite.position.set(position.x, position.y, position.z);
    scene.add(sprite);
  }

  // function for drawing rounded rectangles
  function roundRect(ctx, x, y, w, h, r) {
    ctx.beginPath();
    ctx.moveTo(x+r, y);
    ctx.lineTo(x+w-r, y);
    ctx.quadraticCurveTo(x+w, y, x+w, y+r);
    ctx.lineTo(x+w, y+h-r);
    ctx.quadraticCurveTo(x+w, y+h, x+w-r, y+h);
    ctx.lineTo(x+r, y+h);
    ctx.quadraticCurveTo(x, y+h, x, y+h-r);
    ctx.lineTo(x, y+r);
    ctx.quadraticCurveTo(x, y, x+r, y);
    ctx.closePath();
    ctx.fill();
    ctx.stroke();   
  }
</script>
</body>
</html>
